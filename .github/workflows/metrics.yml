name: Generate GitHub Metrics

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  # ==============================================
  # CUSTOM CODE STATS - Our Own Analytics
  # ==============================================
  code-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: pip install requests
        
      - name: üìä Generate Code Stats
        env:
          METRICS_TOKEN: ${{ secrets.METRICS_TOKEN }}
        run: python scripts/generate_stats.py
        
      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add code-stats.svg stats.json
          git diff --staged --quiet || git commit -m "üìä Update code statistics"
          git push

  # ==============================================
  # MAIN METRICS - Profile Overview + Habits
  # ==============================================
  github-metrics-main:
    runs-on: ubuntu-latest
    steps:
      - name: üìä Generate Main Metrics
        uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.METRICS_TOKEN }}
          committer_token: ${{ secrets.METRICS_TOKEN }}
          committer_branch: main
          filename: github-metrics-main.svg
          user: icetrahan
          template: classic
          base: header, activity, community, repositories
          base_indepth: yes
          config_timezone: America/Chicago
          config_display: large
          config_padding: 6%
          
          # CRITICAL: Include ALL repos (private + org + collaborator)
          repositories_forks: yes
          repositories_affiliations: owner, collaborator, organization_member
          repositories_skipped: ""
          
          # Lines of code (all repos)
          plugin_lines: yes
          plugin_lines_history_limit: 1
          plugin_lines_repositories_limit: 100
          plugin_lines_sections: base
          
          # Coding habits
          plugin_habits: yes
          plugin_habits_from: 1000
          plugin_habits_days: 30
          plugin_habits_charts: yes
          plugin_habits_charts_type: classic
          plugin_habits_trim: yes
          
          # Follow up stats
          plugin_followup: yes
          plugin_followup_archived: yes
          plugin_followup_sections: repositories, user
          plugin_followup_indepth: yes

  # ==============================================
  # SNAKE - Contribution Animation
  # ==============================================
  github-snake:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: üêç Generate Snake
        uses: Platane/snk/svg-only@v3
        with:
          github_user_name: icetrahan
          outputs: |
            dist/snake.svg
            dist/snake-dark.svg?palette=github-dark
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Push Snake
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: output
          build_dir: dist
          keep_history: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}